kind: pipeline
name: default

steps:
- name: publish
  image: golang
  environment:
    GOOS: linux
    PASSWORD:
      from_secret: password

- name: message
  image: ubuntu
  environment:
    BLABLA: linux
    AWS_DEFAULT_REGION: us-east-1
    KUBECONFIG: /drone/src/eks/terraform/kubeconfig
    PASSWORD:
      from_secret: password
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_SECRET_ACCESS_KEY     
  commands:
  - apt-get update
  - apt-get install unzip
  - apt-get install -y wget
  - wget https://releases.hashicorp.com/terraform/0.11.10/terraform_0.11.10_linux_amd64.zip
  - unzip terraform_0.11.10_linux_amd64.zip
  - mv terraform /usr/local/bin/
  - terraform --version 
  - echo "hello world"
  - pwd
  - ls -ltra
  - cp README.md README.md1
  - ls -ltra
  - cp eks/terraform/preprod/* eks/terraform/.
  - ls -ltra
  - ls -ltrs eks/terraform/
  - cd eks/terraform/
  - pwd
  - printenv
  - terraform init
  - terraform plan -out kubernetes.tfplan -input=false
  - terraform apply kubernetes.tfplan
  - # getting kubeconfig
  - terraform output kubeconfig > kubeconfig
  - chmod 0777 kubeconfig
  - #https://docs.docker.com/install/linux/docker-ce/ubuntu/
  - apt-get install -y software-properties-common
  - # Add users to config map
  - # Single quotes for environment vars
  - terraform output config-map-aws-auth > config.yml
  - printf "\n" >> users.yml
  - printf "  mapUsers:"" | \n" >> config.yml
  - while IFS="\n" read -r line;
      do printf "    %s\n" "$line" >> config.yml;
    done < users.yml
  - ls
  - cat users.yml
  - cat config.yml
  - #apt-get install -y gnupg2 gnupg gnupg1
  - apt-get install -y apt-transport-https curl
  - wget https://storage.googleapis.com/kubernetes-release/release/v1.8.6/bin/linux/amd64/kubectl
  - chmod u+x kubectl
  - mv kubectl /usr/local/bin/kubectl
  - #kubectl version
  - #kubectl apply -f config.yml

- name: kubectl
  image: wernight/kubectl
  environment:
    BLABLA: linux
    AWS_DEFAULT_REGION: us-east-1
    KUBECONFIG: /drone/src/eks/terraform/kubeconfig
    PASSWORD:
      from_secret: password
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_SECRET_ACCESS_KEY     
  commands:
  - cd eks/terraform/
  - which kubectl
  - #kubectl version
  - ls -ltra
  - cat config.yml
  - pwd
  - cat kubeconfig
  - kubectl apply -f config.yml --kubeconfig /drone/src/eks/terraform/kubeconfig
  
